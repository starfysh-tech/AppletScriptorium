#!/bin/bash

# segment-salmon - M3U8 Downloader Wrapper Script
# Downloads HLS video streams with dynamic progress bars and lossless quality

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/m3u8_downloader.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}"
    echo "  ┌─────────────────────────────────────────────────┐"
    echo "  │                SEGMENT SALMON                   │"
    echo "  │          M3U8 Downloader with Style             │" 
    echo "  └─────────────────────────────────────────────────┘"
    echo -e "${NC}"
}

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check Python dependencies
check_python_deps() {
    python3 -c "
import sys
missing = []
try:
    import requests
except ImportError:
    missing.append('requests')

try:
    import rich
except ImportError:
    missing.append('rich')

if missing:
    print(' '.join(missing))
    sys.exit(1)
" 2>/dev/null
}

# Function to install Python dependencies
install_python_deps() {
    print_status "Installing Python dependencies..."
    
    if command_exists pip3; then
        pip3 install --user requests rich
    elif command_exists pip; then
        pip install --user requests rich
    else
        print_error "pip/pip3 not found. Please install pip first."
        return 1
    fi
}

# Function to check and install dependencies
check_dependencies() {
    local needs_install=false
    
    # Check Python3
    if ! command_exists python3; then
        print_error "python3 is required but not installed."
        echo "  Install with: brew install python3 (macOS) or apt install python3 (Ubuntu)"
        exit 1
    fi
    
    # Check Python dependencies
    if ! missing_deps=$(check_python_deps); then
        print_warning "Missing Python packages: $missing_deps"
        needs_install=true
    fi
    
    # Check FFmpeg (optional but recommended)
    if ! command_exists ffmpeg; then
        print_warning "ffmpeg not found - will use basic concatenation"
        echo "  For best quality, install with: brew install ffmpeg (macOS) or apt install ffmpeg (Ubuntu)"
        echo
    fi
    
    # Install missing Python dependencies if needed
    if [ "$needs_install" = true ]; then
        echo -n "Install missing dependencies? [Y/n]: "
        read -r response
        case $response in
            [nN][oO]|[nN])
                print_error "Dependencies required to run. Exiting."
                exit 1
                ;;
            *)
                if ! install_python_deps; then
                    print_error "Failed to install dependencies"
                    exit 1
                fi
                print_status "Dependencies installed successfully"
                echo
                ;;
        esac
    fi
}

# Function to show help
show_help() {
    print_header
    echo
    echo "USAGE:"
    echo "  $0 <m3u8_url> [options]"
    echo
    echo "EXAMPLES:"
    echo "  $0 'https://example.com/playlist.m3u8'"
    echo "  $0 'https://example.com/playlist.m3u8' -o ./downloads -n video.mp4"
    echo "  $0 'https://example.com/playlist.m3u8' --quality high --workers 8"
    echo
    echo "OPTIONS:"
    echo "  -o, --output-dir DIR     Output directory (default: current directory)"
    echo "  -n, --name FILE          Output filename (will use .mp4 if FFmpeg available)"
    echo "  --quality PRESET         Video quality: high, medium, low (default: high)"
    echo "  --workers N              Concurrent downloads (default: 2)"
    echo "  --timeout SEC            Request timeout in seconds (default: 30)"
    echo "  --retries N              Retry attempts per segment (default: 3)"
    echo "  -h, --help               Show this help message"
    echo
    echo "FEATURES:"
    echo "  • Lossless concatenation with FFmpeg stream copy"
    echo "  • Dynamic progress bar with download rates & ETA"
    echo "  • Concurrent downloads with configurable workers"
    echo "  • Automatic retry logic with exponential backoff"
    echo "  • Graceful keyboard interrupt handling (Ctrl+C)"
    echo "  • Smart cleanup of temporary files"
    echo
    echo "DEPENDENCIES:"
    echo "  • python3 (required)"
    echo "  • requests (auto-installed)"
    echo "  • rich (auto-installed)"
    echo "  • ffmpeg (optional, for best quality)"
    echo
}

# Main execution
main() {
    # Show help if no arguments provided
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    # Check for help flag
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
    esac
    
    # Check if Python script exists
    if [ ! -f "$PYTHON_SCRIPT" ]; then
        print_error "Python script not found: $PYTHON_SCRIPT"
        exit 1
    fi
    
    # Check dependencies
    check_dependencies
    
    # Run the Python script with all arguments
    print_status "Starting segment-salmon downloader..."
    echo
    
    exec python3 "$PYTHON_SCRIPT" "$@"
}

# Run main function with all arguments
main "$@"